import{i as b,d as j,s as y,t as m,j as e,f as M,r as C,u as q,b as N,M as _,V as P}from"./index-f1I_60Wl.js";import{C as L,a as v,b as g,d as u,e as w,f as F,g as A,h as Q,i as E}from"./context-menu-C3rLmken.js";import{S as k}from"./smart-marquee-CItSSMHC.js";import{u as R}from"./use-saved-playlists-Dm7V3yRX.js";import{u as $}from"./useQuery-CXSgYr8k.js";function K(){const n=b(),{mutate:s}=j({mutationFn:a=>y.player.addItemToPlaybackQueue(a.uri),onSuccess:(a,t)=>{m.success(e.jsxs("p",{children:["Added ",e.jsx("b",{children:t.name})," to queue"]}))},onError:a=>{console.error(a),m.error("Failed to add to queue")},onSettled:()=>{n.invalidateQueries({queryKey:["queue"]})}});return s}function O(){const n=b(),{mutate:s}=j({mutationFn:a=>y.playlists.addItemsToPlaylist(a.playlist.id,[a.item.uri]),onSuccess:(a,t)=>{setTimeout(()=>{n.invalidateQueries({refetchType:"all",queryKey:["playlist-tracks","playlist",t.playlist.id]})},1e3),m.success("Added to playlist",{description:e.jsxs(e.Fragment,{children:["Added ",e.jsx("b",{children:t.item.name})," to ",e.jsx("b",{children:t.playlist.name})]})})},onError:(a,t)=>{console.error(a),m.error("Failed to add to playlist",{description:e.jsxs(e.Fragment,{children:["Could not add ",e.jsx("b",{children:t.item.name})," to ",e.jsx("b",{children:t.playlist.name})]})})}});return s}function G(){const n=b(),{mutate:s}=j({mutationFn:a=>{const{playlistId:t,trackUris:i}=a;return y.playlists.removeItemsFromPlaylist(t,{tracks:i.map(o=>({uri:o}))})},onSuccess:(a,t)=>{m.success("Removed item from playlist"),setTimeout(()=>{n.invalidateQueries({queryKey:["playlist",t.playlistId]}),n.invalidateQueries({queryKey:["playlist-tracks",t.playlistId]})},1e3)},onError:a=>{console.error(a),m.success("Failed to remove item from playlist")}});return s}function D(n){const{track:s,enabled:a,initial:t=!1}=n,{id:i,name:o}=s,l=b(),{data:r,refetch:p}=$({queryKey:["is-liked",i],initialData:[t??!0],queryFn:()=>y.currentUser.tracks.hasSavedTracks([i]),select:d=>d[0],enabled:a&&!t}),{mutate:x}=j({mutationFn:()=>y.makeRequest(r?"DELETE":"PUT","me/tracks",{ids:[s.id]}),onSuccess:()=>{l.invalidateQueries({queryKey:["liked_songs"]}),setTimeout(p,500),m.success(`${r?"Removed":"Added"} ${o} ${r?"from":"to"} Liked Songs`)},onError:d=>{console.error(d),m.error(`Failed to ${r?"remove":"add"} ${o} ${r?"from":"to"} Liked Songs`)}});return{isSaved:r,toggleLiked:x}}function U(n){const{track:s}=n,[a,t]=C.useState(!1),{playlists:i,isLoading:o}=R({enabled:a,ownerOnly:!0}),l=O();return e.jsxs(w,{onOpenChange:t,children:[e.jsx(F,{children:"Add to playlist"}),e.jsxs(A,{className:"max-h-80 overflow-y-auto",children:[e.jsx(u,{disabled:!0,children:"New Playlist"}),e.jsx(g,{}),o?e.jsx(v,{className:"animate-pulse text-center",children:"..."}):i.map((r,p)=>e.jsx(u,{onSelect:x=>x.preventDefault(),className:"truncate",onClick:()=>l({item:s,playlist:r}),children:r.name},p))]})]})}function V(n){const{track:s,open:a,isLiked:t,playlistId:i,showGoToAlbum:o=!0}=n,l=M(),r=K(),p=G(),{toggleLiked:x,isSaved:d}=D({track:s,enabled:a,initial:t});return e.jsxs(L,{children:["album"in s&&e.jsxs(e.Fragment,{children:[e.jsxs(v,{className:"grid w-60 grid-cols-[auto_1fr] grid-rows-[repeat(auto,4)] items-center gap-x-3 [&_*]:text-xs",children:[e.jsx("img",{className:"col-span-1 row-span-4 size-20 rounded-sm border-[0.0625rem] border-fg",src:s.album.images.length>0?s.album.images[0].url:""}),e.jsx(k,{className:"row-span-1",children:s.name}),e.jsx(k,{className:"row-span-1",children:s.artists.map(c=>c.name).join(",")}),e.jsx(k,{className:"row-span-1",children:s.album.name}),e.jsx(k,{className:"row-span-1",children:new Date(s.album.release_date).getFullYear()})]}),e.jsx(g,{})]}),e.jsx(U,{track:s}),i&&e.jsx(u,{onClick:()=>p({playlistId:i,trackUris:[s.uri]}),children:"Remove from this playlist"}),e.jsxs(u,{onClick:()=>x(),children:[d?"Remove from":"Add to"," Liked Songs"]}),e.jsx(u,{onClick:()=>r(s),children:"Add to queue"}),e.jsx(g,{}),"artists"in s&&(s.artists.length===1?e.jsx(u,{onClick:l(s.artists[0].name,"Artist",{id:s.artists[0].id}),children:"Go to artist"}):e.jsxs(w,{children:[e.jsx(F,{children:"Go to artist"}),e.jsx(A,{className:"w-44",children:s.artists.sort((c,h)=>c.name.localeCompare(h.name)).map(c=>e.jsx(u,{onClick:l(c.name,"Artist",{id:c.id}),children:c.name}))})]})),o&&"album"in s&&e.jsx(u,{onClick:l(s.album.name,"Album",{id:s.album.id}),children:"Go to album"})]})}function z(n){var S;const{track:s,trackNumber:a,onClick:t,isLiked:i,playlistId:o,showGoToAlbum:l=!0,...r}=n,[p,x]=C.useState(!1),d=a??("track_number"in s?s.track_number:null),c=d?`${d}. `:null,h=q(N(f=>{var T;return(T=f.item)==null?void 0:T.id})),I=t&&(f=>{t&&t(f)});return e.jsxs(Q,{onOpenChange:x,children:[e.jsx(E,{asChild:!0,children:e.jsxs(_,{disabled:s.is_playable&&!s.is_playable||!!s.restrictions,onClick:I,...r,icon:h===s.id||"linked_from"in s&&((S=s.linked_from)==null?void 0:S.id)===h?P:!1,children:[c,s.name]})}),e.jsx(V,{track:s,open:p,isLiked:i,playlistId:o,showGoToAlbum:l})]})}const X=C.memo(z);export{X as T};
